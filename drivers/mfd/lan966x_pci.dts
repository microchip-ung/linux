// SPDX-License-Identifier: GPL-2.0
/*
 * Copyright (C) 2022 Microchip UNG
 */

#include <dt-bindings/clock/microchip,lan966x.h>
#include <dt-bindings/mfd/atmel-flexcom.h>
#include <dt-bindings/soc/mchp,lan966x_icpu.h>
#include <dt-bindings/phy/phy-lan966x-serdes.h>
#include <dt-bindings/gpio/gpio.h>

/dts-v1/;
/plugin/;

&{/pcidev} {
	compatible = "simple-bus";
	#address-cells = <1>;
	#size-cells = <1>;

	itc: itc {
		#interrupt-cells = <1>;
		interrupt-controller;
		interrupt-parent = <&itc>;
	};

	cpu_clk: cpu_clk {
		compatible = "fixed-clock";
		#clock-cells = <0>;
		clock-frequency = <600000000>;  // CPU clock = 600MHz
	};

	fabric_clk: fabric_clk {
		compatible = "fixed-clock";
		#clock-cells = <0>;
		clock-frequency = <30000000>;  // Fabric clock = 30MHz
	};

	sys_clk: sys_clk {
		compatible = "fixed-clock";
		#clock-cells = <0>;
		clock-frequency = <15625000>;  // System clock = 15.625MHz
	};

	nic_clk: nic_clk {
		compatible = "fixed-clock";
		#clock-cells = <0>;
		clock-frequency = <200000000>;  // NIC clock = 200MHz
	};

	clks: clock-controller@e00c00a8 {
		compatible = "microchip,lan966x-gck";
		#clock-cells = <1>;
		clocks = <&cpu_clk>, <&fabric_clk>, <&sys_clk>;
		reg = <CPU_GCK_REGS_ADDR CPU_GCK_REGS_SIZE>;
	};

	cpu_ctrl: syscon@e00c0000 {
		compatible = "microchip,lan966x-cpu-syscon", "syscon";
		reg = <CPU_ADDR CPU_SIZE>;
	};

	switch_ctrl: syscon@e200400c {
		compatible = "microchip,lan966x-switch-syscon", "syscon";
		reg = <GCB_ADDR 0x4>;
	};

	chip_ctrl: syscon@e2010000 {
		compatible = "microchip,lan966x-chip-syscon", "syscon";
		reg = <CHIP_TOP_CUPHY_CFG_ADDR CHIP_TOP_CUPHY_CFG_SIZE>;
	};

	switch_reset: switch_reset@0 {
		compatible = "microchip,lan966x-switch-reset";
		#reset-cells = <1>;
		cpu-syscon = <&cpu_ctrl>;
		switch-syscon = <&switch_ctrl>;
		chip-syscon = <&chip_ctrl>;
	};

	lan966x_gpio: pinctrl@e2004070 {
		compatible = "microchip,lan966x-pinctrl";
		reg = <GCB_GPIO_ADDR GCB_GPIO_SIZE>,
			<CHIP_TOP_GPIO_CFG_ADDR CHIP_TOP_GPIO_CFG_SIZE>;
		gpio-controller;
		#gpio-cells = <2>;
		gpio-ranges = <&lan966x_gpio 0 0 78>;
		interrupt-parent = <&itc>;
		interrupt-controller;
		interrupts = <17>;
		#interrupt-cells = <1>;

		tod_pins: tod_pins {
			pins = "GPIO_36";
			function = "ptpsync_1";
		};

		fc0_a_rx_pins: fc0-a-rx-pins {
			pins = "GPIO_9";
			function = "fc0_a";
		};

		fc0_a_tx_pins: fc0-a-tx-pins {
			pins = "GPIO_10";
			function = "fc0_a";
		};

		i2cmux_pins: i2cmux-pins {
			pins = "GPIO_76", "GPIO_77";
			function = "twi_slc_gate";
			output-low;
		};

		i2cmux_0: i2cmux-0 {
			pins = "GPIO_76";
			function = "twi_slc_gate";
			output-high;
		};

		i2cmux_1: i2cmux-1 {
			pins = "GPIO_77";
			function = "twi_slc_gate";
			output-high;
		};
	};

	flx0: flexcom@e0070000 {
		compatible = "atmel,sama5d2-flexcom";
		reg = <FLEXCOM_0_FLEXCOM_REG_ADDR FLEXCOM_0_FLEXCOM_REG_SIZE>;
		clocks = <&fabric_clk>;
		#address-cells = <1>;
		#size-cells = <1>;
		ranges = <0x0 FLEXCOM_0_FLEXCOM_REG_ADDR 0x800>;

		atmel,flexcom-mode = <ATMEL_FLEXCOM_MODE_TWI>;

		i2c_lan966x: i2c@600 {
			compatible = "microchip,sam9x60-i2c";
			reg = <0x600 0x200>;
			interrupt-parent = <&itc>;
			interrupts = <48>;
			#address-cells = <1>;
			#size-cells = <0>;
			clocks = <&nic_clk>;
			pinctrl-0 = <&fc0_a_rx_pins>, <&fc0_a_tx_pins>;
			pinctrl-names = "default";
			i2c-analog-filter;
			i2c-digital-filter;
			i2c-digital-filter-width-ns = <35>;
			i2c-sda-hold-time-ns = <1500>;
		};
	};

	i2c0_emux: i2c0-emux@0 {
		compatible = "i2c-mux-pinctrl";
		#address-cells = <1>;
		#size-cells = <0>;
		i2c-parent = <&i2c_lan966x>;
		pinctrl-names = "i2c102", "i2c103", "idle";
		pinctrl-0 = <&i2cmux_0>;
		pinctrl-1 = <&i2cmux_1>;
		pinctrl-2 = <&i2cmux_pins>;

		i2c102: i2c_sfp1 {
			reg = <0>;
			#address-cells = <1>;
			#size-cells = <0>;
		};

		i2c103: i2c_sfp2 {
			reg = <1>;
			#address-cells = <1>;
			#size-cells = <0>;
		};
	};

	sfp_eth2: sfp-eth2 {
		compatible       = "sff,sfp";
		i2c-bus          = <&i2c102>;
		tx-disable-gpios = <&lan966x_gpio  0 GPIO_ACTIVE_HIGH>;
		los-gpios        = <&lan966x_gpio 25 GPIO_ACTIVE_HIGH>;
		mod-def0-gpios   = <&lan966x_gpio 18 GPIO_ACTIVE_LOW>;
		tx-fault-gpios   = <&lan966x_gpio  2 GPIO_ACTIVE_HIGH>;
	};

	sfp_eth3: sfp-eth3 {
		compatible       = "sff,sfp";
		i2c-bus          = <&i2c103>;
		tx-disable-gpios = <&lan966x_gpio  1 GPIO_ACTIVE_HIGH>;
		los-gpios        = <&lan966x_gpio 26 GPIO_ACTIVE_HIGH>;
		mod-def0-gpios   = <&lan966x_gpio 19 GPIO_ACTIVE_LOW>;
		tx-fault-gpios   = <&lan966x_gpio  3 GPIO_ACTIVE_HIGH>;
	};

	hsio: syscon@710d0000 {
		compatible = "microchip,lan966x-hsio", "syscon", "simple-mfd";
		reg = <HSIO_ADDR HSIO_SIZE>;

		serdes: serdes {
			compatible = "microchip,lan966x-serdes";
			#phy-cells = <2>;
		};
	};

	lan966x_mdio1: mdio@413c {
		#address-cells = <1>;
		#size-cells = <0>;
		compatible = "mscc,ocelot-miim";
		reg = <GCB_MIIM_1_ADDR GCB_MIIM_1_SIZE>;

		resets = <&switch_reset 0>;
		reset-names = "switch";

		lan966x_phy0: ethernet-lan966x_phy@1 {
			reg = <1>;
		};

		lan966x_phy1: ethernet-lan966x_phy@2 {
			reg = <2>;
		};
	};

	lan966x_switch: switch@0 {
		compatible = "mchp,lan966x-switch";
		reg = <ORG_0_ADDR ORG_0_SIZE>,
			<SYS_ADDR SYS_SIZE>,
			<QS_ADDR QS_SIZE>,
			<QSYS_ADDR QSYS_SIZE>,

			<ANA_ADDR ANA_SIZE>,
			<REW_ADDR REW_SIZE>,
			<GCB_ADDR 0x44>,
			<PTP_ADDR PTP_SIZE>,

			<VCAP_0_ADDR VCAP_0_SIZE>,
			<VCAP_1_ADDR VCAP_1_SIZE>,
			<VCAP_2_ADDR VCAP_2_SIZE>,
			<AFI_ADDR AFI_SIZE>,
			<MEP_ADDR MEP_SIZE>,

			<CPU_ADDR CPU_SIZE>,
			<FDMA_ADDR FDMA_SIZE>,
			<CHIP_TOP_ADDR CHIP_TOP_SIZE>,

			<DEV_0_ADDR DEV_0_SIZE>,
			<DEV_1_ADDR DEV_1_SIZE>,
			<DEV_2_ADDR DEV_2_SIZE>,
			<DEV_3_ADDR DEV_3_SIZE>,
			<DEV_4_ADDR DEV_4_SIZE>,
			<DEV_5_ADDR DEV_5_SIZE>,
			<DEV_6_ADDR DEV_6_SIZE>,
			<DEV_7_ADDR DEV_7_SIZE>;

		reg-names = "org", "sys", "qs", "qsys",
				"ana", "rew", "gcb", "ptp",
				"es0", "s1", "s2", "afi", "mep",
				"cpu", "fdma", "chip_top",
				"port0", "port1", "port2", "port3",
				"port4", "port5", "port6", "port7";

		interrupt-parent = <&itc>;
		interrupts = <10 11 12 9>;
		interrupt-names = "ptp-sync", "ptp", "xtr", "ana";

		resets = <&switch_reset 0>;
		reset-names = "switch";

		pinctrl-names = "default";
		pinctrl-0 = <&tod_pins>;

		ethernet-ports {
			#address-cells = <1>;
			#size-cells = <0>;

			port0: port@0 {
				phy-handle = <&lan966x_phy0>;

				reg = <0>;
				phy-mode = "gmii";
				phys = <&serdes 0 CU(0)>;

				#address-cells = <1>;
				#size-cells = <0>;

				delay0 {
					reg = <0>;
					speed = <1000>;
					rx_delay = <0x25000>;
					tx_delay = <0x25000>;
				};

				delay1 {
					reg = <0>;
					speed = <100>;
					rx_delay = <0x8f050>;
					tx_delay = <0x8f050>;
				};

				delay2 {
					reg = <0>;
					speed = <10>;
					rx_delay = <0x4b8000>;
					tx_delay = <0x4b8000>;
				};
			};

			port1: port@1 {
				phy-handle = <&lan966x_phy1>;

				reg = <1>;
				phy-mode = "gmii";
				phys = <&serdes 1 CU(1)>;

				#address-cells = <1>;
				#size-cells = <0>;

				delay0 {
					reg = <0>;
					speed = <1000>;
					rx_delay = <0x25000>;
					tx_delay = <0x25000>;
				};

				delay1 {
					reg = <0>;
					speed = <100>;
					rx_delay = <0x8f050>;
					tx_delay = <0x8f050>;
				};

				delay2 {
					reg = <0>;
					speed = <10>;
					rx_delay = <0x4b8000>;
					tx_delay = <0x4b8000>;
				};
			};

			port2: port@2 {
				reg = <2>;
				phy-mode = "sgmii";
				phys = <&serdes 2 SERDES6G(0)>;
				sfp = <&sfp_eth2>;
				managed = "in-band-status";

				#address-cells = <1>;
				#size-cells = <0>;

				delay0 {
					reg = <0>;
					speed = <1000>;
					rx_delay = <0x25000>;
					tx_delay = <0x25000>;
				};

				delay1 {
					reg = <0>;
					speed = <100>;
					rx_delay = <0x8f050>;
					tx_delay = <0x8f050>;
				};

				delay2 {
					reg = <0>;
					speed = <10>;
					rx_delay = <0x4b8000>;
					tx_delay = <0x4b8000>;
				};
			};

			port3: port@3 {
				reg = <3>;
				phy-mode = "sgmii";
				phys = <&serdes 3 SERDES6G(1)>;
				sfp = <&sfp_eth3>;
				managed = "in-band-status";

				#address-cells = <1>;
				#size-cells = <0>;

				delay0 {
					reg = <0>;
					speed = <1000>;
					rx_delay = <0x25000>;
					tx_delay = <0x25000>;
				};

				delay1 {
					reg = <0>;
					speed = <100>;
					rx_delay = <0x8f050>;
					tx_delay = <0x8f050>;
				};

				delay2 {
					reg = <0>;
					speed = <10>;
					rx_delay = <0x4b8000>;
					tx_delay = <0x4b8000>;
				};
			};
		};
	};
};
